<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Backrooms ‚Äî Mini-jeu 2D</title>
  <style>
    html,body{
      height:100%;
      width:100%;
      margin:0;
      overflow:hidden;
      background:#111;
      color:#ddd;
      font-family:Arial;
    }
    canvas{
      background:#222;
      display:block;
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      image-rendering:pixelated;
    }
    #hud{
      position:fixed;
      left:10px;
      top:10px;
      width:220px;
      z-index:10;
    }
    .bar{
      height:18px;
      background:#333;
      border-radius:6px;
      margin-bottom:6px;
      overflow:hidden;
    }
    .bar > .fill{
      height:100%;
      width:100%;
      background:linear-gradient(90deg,#6ee,#08f);
      transition:width 0.1s;
    }
    #bar-noise > .fill{background:linear-gradient(90deg,#0f0,#f00);}
    #bar-battery > .fill{background:linear-gradient(90deg,#b6ffb6,#6f6);}
    #inventory{
      position:fixed;
      right:10px;
      top:10px;
      width:200px;
      background:rgba(0,0,0,0.4);
      padding:8px;
      border-radius:8px;
      z-index:10;
    }
    #inventory img{
      width:40px;
      height:40px;
      margin:4px;
    }
    #minimap{
      position:fixed;
      right:10px;
      bottom:10px;
      border-radius:6px;
      background:#000;
      padding:6px;
      z-index:10;
    }
    #overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.6);
      z-index:50;
      visibility:hidden;
    }
    #overlay .box{
      background:#111;
      padding:20px;
      border-radius:8px;
      border:2px solid #444;
      text-align:center;
    }
    button{
      padding:8px 12px;
      margin-top:10px;
      border-radius:6px;
      border:0;
      background:#2b6;
      color:#012;
    }
  </style>
</head>
<body>
  <canvas id="world"></canvas>
  <div id="hud">
    <div>Stamina</div>
    <div id="bar-stamina" class="bar"><div class="fill" style="width:100%"></div></div>
    <div>Bruit</div>
    <div id="bar-noise" class="bar"><div class="fill" style="width:0%"></div></div>
    <div>Batterie</div>
    <div id="bar-battery" class="bar"><div class="fill" style="width:0%"></div></div>
  </div>
  <div id="inventory">
    <div><strong>Inventaire</strong></div>
    <div id="inv-items"></div>
    <div style="font-size:12px;margin-top:6px;color:#bbb">
      Touches: E=R√©cup√©rer, F=Lampe, R=Pi√®ge, Shift=Courir
    </div>
  </div>
  <div id="minimap">
    <canvas id="mapmini" width="200" height="120"></canvas>
  </div>
  <div id="overlay"><div class="box" id="overlay-box"></div></div>

  <script>
  const TILE = 96; // üîç Zoom x2
  const MAP_W = 60, MAP_H = 40;
  const worldCanvas = document.getElementById('world');
  const ctx = worldCanvas.getContext('2d');
  function resizeCanvas(){
    worldCanvas.width=window.innerWidth;
    worldCanvas.height=window.innerHeight;
  }
  window.addEventListener('resize',resizeCanvas);
  resizeCanvas();

  const miniCanvas=document.getElementById('mapmini');
  const mctx=miniCanvas.getContext('2d');

  const player={
    x:MAP_W/2,
    y:MAP_H/2,
    speed:0.75/TILE,       // üê¢ moiti√© plus lent
    runningSpeed:1.25/TILE, // üê¢ moiti√© plus lent
    stamina:1,
    maxStamina:1,
    hasFlash:false,
    battery:0,
    inv:{flashlight:0,battery:0,chocolate:0,trap:0}
  };

  const monsters=[],traps=[];
  let bigMonster=null,door=null,noise=0,flashOn=false,gameOver=false,won=false;

  const map=new Array(MAP_H).fill(0).map(()=>new Array(MAP_W).fill(0));
  function randInt(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
  function generateMap(){
    for(let y=0;y<MAP_H;y++)for(let x=0;x<MAP_W;x++)map[y][x]=0;
    let x=Math.floor(MAP_W/2),y=Math.floor(MAP_H/2);
    map[y][x]=1;
    for(let i=0;i<MAP_W*MAP_H*2;i++){
      const d=Math.random();
      if(d<0.25)x++; else if(d<0.5)x--; else if(d<0.75)y++; else y--;
      x=clamp(x,1,MAP_W-2); y=clamp(y,1,MAP_H-2);
      map[y][x]=1;
      if(Math.random()<0.02){
        const rw=randInt(3,7),rh=randInt(3,6);
        for(let yy=y-1;yy<=y+rh;yy++)
          for(let xx=x-1;xx<=x+rw;xx++)
            if(xx>0&&yy>0&&xx<MAP_W-1&&yy<MAP_H-1)map[yy][xx]=1;
      }
    }
    for(let y=0;y<MAP_H;y++)
      for(let x=0;x<MAP_W;x++)
        if(map[y][x]==1) map[y][x]=(Math.random()<0.7?1:2);
    map[2][Math.floor(MAP_W/2)]=3;
    door={x:Math.floor(MAP_W/2),y:2};
  }
  generateMap();

  const keys={};
  window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
  window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

  function update(dt){
    if(gameOver||won)return;
    let dx=0,dy=0;
    if(keys['z']||keys['arrowup'])dy-=1;
    if(keys['s']||keys['arrowdown'])dy+=1;
    if(keys['q']||keys['arrowleft'])dx-=1;
    if(keys['d']||keys['arrowright'])dx+=1;
    const run=keys['shift'];
    const mag=Math.hypot(dx,dy)||1;
    const moveSpeed=run?player.runningSpeed:player.speed;
    const ndx=(dx/mag)*moveSpeed*dt*60;
    const ndy=(dy/mag)*moveSpeed*dt*60;
    if(run&&(dx||dy)&&player.stamina>0){
      player.x+=ndx; player.y+=ndy;
      player.stamina=clamp(player.stamina-0.3*dt,0,player.maxStamina);
      noise=clamp(noise+0.4*dt,0,1);
    }else if((dx||dy)){
      player.x+=ndx; player.y+=ndy;
      player.stamina=clamp(player.stamina+0.3*dt,0,player.maxStamina);
    }else{
      player.stamina=clamp(player.stamina+0.5*dt,0,player.maxStamina);
      noise=clamp(noise-0.4*dt,0,1);
    }
    updateUI();
  }

  function updateUI(){
    document.querySelector('#bar-stamina .fill').style.width=(player.stamina/player.maxStamina*100)+'%';
    document.querySelector('#bar-noise .fill').style.width=(noise*100)+'%';
    document.querySelector('#bar-battery .fill').style.width=(player.battery*100)+'%';
  }

  function draw(){
    ctx.clearRect(0,0,worldCanvas.width,worldCanvas.height);
    const camx=player.x*TILE-worldCanvas.width/2;
    const camy=player.y*TILE-worldCanvas.height/2;
    for(let y=0;y<MAP_H;y++)
      for(let x=0;x<MAP_W;x++){
        const sx=x*TILE-camx,sy=y*TILE-camy;
        if(sx<-TILE||sy<-TILE||sx>worldCanvas.width||sy>worldCanvas.height)continue;
        if(map[y][x]==0)ctx.fillStyle='#000';
        else if(map[y][x]==1)ctx.fillStyle='#f7f1c7';
        else if(map[y][x]==2)ctx.fillStyle='#9a9a9a';
        else if(map[y][x]==3)ctx.fillStyle='#8b5cf6';
        ctx.fillRect(sx,sy,TILE,TILE);
      }
    ctx.fillStyle='lime';
    ctx.fillRect(player.x*TILE-camx-12,player.y*TILE-camy-12,24,24);
  }

  let last=performance.now();
  function loop(ts){
    const dt=Math.min(0.05,(ts-last)/1000);
    last=ts;
    update(dt);
    draw();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
  </script>
</body>
</html>
